--- elektra-0.8.3-r2.ebuild	2013-04-22 16:17:35.000000000 +0200
+++ elektra-0.8.4.ebuild	2014-02-15 22:09:46.444495407 +0100
@@ -13,38 +13,44 @@
 LICENSE="BSD"
 SLOT="0"
 KEYWORDS="~amd64 ~x86"
-IUSE="dbus doc examples iconv inifile simpleini static-libs syslog tcl test xml yajl"
+IUSE="dbus doc examples iconv simpleini static-libs syslog tcl test +uname xml yajl"
 
-RDEPEND="!amd64? ( dev-libs/libxml2 )
-	amd64? (
-		abi_x86_64? ( dev-libs/libxml2 )
-		abi_x86_32? ( app-emulation/emul-linux-x86-baselibs ) )"
+RDEPEND="dev-libs/libxml2[${MULTILIB_USEDEP}]
+	uname? ( sys-apps/coreutils )"
 DEPEND="${RDEPEND}
 	!amd64? ( sys-devel/libtool )
 	doc? ( app-doc/doxygen )
 	iconv? ( virtual/libiconv )
-	!amd64? ( test? ( dev-libs/libxml2[static-libs] ) )
+	test? ( dev-libs/libxml2[static-libs,${MULTILIB_USEDEP}] )
 	yajl? ( <dev-libs/yajl-2 )"
 
+DOCS="doc/AUTHORS doc/CHANGES doc/NEWS doc/README doc/todo/TODO"
+
+src_prepare() {
+	# Various upstream patches to fix stuff and make ebuild hacks obsolete
+	epatch	"${FILESDIR}/${PN}-0.8.4-install-header-correctly.patch"
+	epatch	"${FILESDIR}/${PN}-0.8.4-fix-man-pages-name-collision.patch"
+	epatch	"${FILESDIR}/${PN}-0.8.4-fix-dependency-to-correct-man-page.patch"
+	# Fix manpage install dir once and for all
+	epatch	"${FILESDIR}/${PN}-0.8.4-finally-fix-manpage-install-dir.patch"
+}
+
 src_configure() {
 	local my_plugins="ccode;dump;error;fstab;glob;hexcode;hidden;hosts;network;ni;null;path;resolver;struct;success;template;timeofday;tracer;type;validation"
 
-	#fix QA issues with upstream patches
-	epatch "${FILESDIR}/${P}-introduce-attributes.patch"
-	epatch "${FILESDIR}/${P}-fix-yajl-if-user-config.patch"
-
 	#move doc files to correct location
 	sed -e "s/elektra-api/${PF}/" \
 		-i cmake/ElektraCache.cmake || die
 
-	use dbus    && my_plugins+=";dbus"
-	use doc     && my_plugins+=";doc"
-	use iconv   && my_plugins+=";iconv"
-	use inifile && my_plugins+=";simpleini"
-	use syslog  && my_plugins+=";syslog"
-	use tcl     && my_plugins+=";tcl"
-	use xml     && my_plugins+=";xmltool"
-	use yajl    && my_plugins+=";yajl"
+	use dbus      && my_plugins+=";dbus"
+	use doc       && my_plugins+=";doc"
+	use iconv     && my_plugins+=";iconv"
+	use simpleini && my_plugins+=";simpleini"
+	use syslog    && my_plugins+=";syslog"
+	use tcl       && my_plugins+=";tcl"
+	use uname     && my_plugins+=";uname"
+	use xml       && my_plugins+=";xmltool"
+	use yajl      && my_plugins+=";yajl"
 
 	mycmakeargs=(
 		"-DPLUGINS=${my_plugins}"
@@ -59,24 +65,11 @@
 	cmake-multilib_src_configure
 }
 
-src_compile() {
-	dodir /usr/share/man/man3
-	cmake-multilib_src_compile
-}
-
 src_install() {
 	cmake-multilib_src_install
 
-	dodoc doc/{AUTHORS,CHANGES,NEWS,README,todo/TODO}
-
 	if use doc ; then
-		rm -rf "${D}/usr/share/doc/${PF}/man" || die
-		pushd ${CMAKE_BUILD_DIR}/doc/man/man3
-		local my_f
-		for my_f in *.3 ; do
-			newman ${my_f} ${PN}-${my_f}
-			elog "installed /usr/share/man/man3/${my_f} as ${PN}-${my_f}"
-		done
-		popd
+		# Remove bogus files
+		rm -rf "${D}"/usr/share/man/man3elektra/_var_tmp_portage* || die
 	fi
 }
