From 4b5082ea9043b4416f1f7496281beb2bd3a28d1a Mon Sep 17 00:00:00 2001
From: Andreas Sturmlechner <asturm@gentoo.org>
Date: Tue, 13 Oct 2020 01:04:44 +0200
Subject: [PATCH 1/2] Add option INSTALL_PAM_EXAMPLES to conditionally install
 pam.d config

---
 CMakeLists.txt          | 1 +
 services/CMakeLists.txt | 2 ++
 2 files changed, 3 insertions(+)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 6936b31..5e8d02d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -32,6 +32,7 @@ add_custom_target(dist COMMAND ${CMAKE_MAKE_PROGRAM} package_source)
 option(BUILD_MAN_PAGES "Build man pages" OFF)
 option(ENABLE_JOURNALD "Enable logging to journald" ON)
 option(ENABLE_PAM "Enable PAM support" ON)
+option(INSTALL_PAM_EXAMPLES "Install PAM configuration examples" ON)
 option(NO_SYSTEMD "Disable systemd support" OFF)
 option(USE_ELOGIND "Use elogind instead of logind" OFF)
 
diff --git a/services/CMakeLists.txt b/services/CMakeLists.txt
index 5032f33..3d12eec 100644
--- a/services/CMakeLists.txt
+++ b/services/CMakeLists.txt
@@ -11,6 +11,7 @@ else()
 endif()
 configure_file("${CMAKE_CURRENT_SOURCE_DIR}/sddm-greeter.pam.in" "${CMAKE_CURRENT_BINARY_DIR}/sddm-greeter.pam")
 
+if(INSTALL_PAM_EXAMPLES)
 if(EXISTS "/etc/debian_version")
     install(FILES debian.sddm-autologin.pam DESTINATION ${CMAKE_INSTALL_FULL_SYSCONFDIR}/pam.d RENAME sddm-autologin)
     install(FILES debian.sddm-greeter.pam DESTINATION ${CMAKE_INSTALL_FULL_SYSCONFDIR}/pam.d RENAME sddm-greeter)
@@ -25,3 +26,4 @@ else()
     install(FILES sddm.pam DESTINATION ${CMAKE_INSTALL_FULL_SYSCONFDIR}/pam.d RENAME sddm)
     install(FILES "${CMAKE_CURRENT_BINARY_DIR}/sddm-greeter.pam" DESTINATION ${CMAKE_INSTALL_FULL_SYSCONFDIR}/pam.d RENAME sddm-greeter)
 endif()
+endif()
-- 
2.35.1


From 02a13d11dac72699e7580c538c152a7b5e0eb056 Mon Sep 17 00:00:00 2001
From: Andreas Sturmlechner <asturm@gentoo.org>
Date: Tue, 13 Oct 2020 01:10:00 +0200
Subject: [PATCH 2/2] Don't add pam_systemd.so to pam.d/sddm-greeter in case of
 NO_SYSTEMD

---
 services/CMakeLists.txt      | 7 +++++--
 services/sddm-greeter.pam.in | 2 +-
 2 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/services/CMakeLists.txt b/services/CMakeLists.txt
index 3d12eec..2ff13a8 100644
--- a/services/CMakeLists.txt
+++ b/services/CMakeLists.txt
@@ -4,10 +4,13 @@ if(SYSTEMD_FOUND)
     install(FILES "${CMAKE_CURRENT_BINARY_DIR}/sddm.service" DESTINATION "${SYSTEMD_SYSTEM_UNIT_DIR}")
 endif()
 
+set(LOGIND_PAM_MODULE "session		optional")
 if(USE_ELOGIND)
-    set(LOGIND_PAM_MODULE "pam_elogind.so")
+    set(LOGIND_PAM_MODULE "${LOGIND_PAM_MODULE}	pam_elogind.so")
+elseif(NOT NO_SYSTEMD)
+    set(LOGIND_PAM_MODULE "${LOGIND_PAM_MODULE}	pam_systemd.so")
 else()
-    set(LOGIND_PAM_MODULE "pam_systemd.so")
+    set(LOGIND_PAM_MODULE "")
 endif()
 configure_file("${CMAKE_CURRENT_SOURCE_DIR}/sddm-greeter.pam.in" "${CMAKE_CURRENT_BINARY_DIR}/sddm-greeter.pam")
 
diff --git a/services/sddm-greeter.pam.in b/services/sddm-greeter.pam.in
index d41792d..35dcfd5 100644
--- a/services/sddm-greeter.pam.in
+++ b/services/sddm-greeter.pam.in
@@ -14,4 +14,4 @@ password	required pam_deny.so
 
 # Setup session
 session		required pam_unix.so
-session		optional @LOGIND_PAM_MODULE@
+@LOGIND_PAM_MODULE@
-- 
2.35.1

