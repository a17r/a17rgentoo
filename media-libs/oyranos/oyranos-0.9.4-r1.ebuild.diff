--- media-libs/oyranos/oyranos-0.9.4.ebuild	2013-04-13 02:01:20.000000000 +0200
+++ media-libs/oyranos/oyranos-0.9.4-r1.ebuild	2013-04-21 19:22:25.611629207 +0200
@@ -1,6 +1,6 @@
 # Copyright 1999-2013 Gentoo Foundation
 # Distributed under the terms of the GNU General Public License v2
-# $Header: /var/cvsroot/gentoo-x86/media-libs/oyranos/oyranos-0.9.4.ebuild,v 1.2 2013/04/12 23:54:12 xmw Exp $
+# $Header: $
 
 EAPI=5
 
@@ -9,16 +9,25 @@
 DESCRIPTION="colour management system allowing to share various settings across applications and services"
 HOMEPAGE="http://www.oyranos.org/"
 SRC_URI="mirror://sourceforge/oyranos/Oyranos/Oyranos%200.4/${P}.tar.bz2"
+if [[ ${PV} == "9999" ]] ; then
+        EGIT_REPO_URI="git://www.oyranos.org/git/oyranos"
+        inherit git-2
+        SRC_URI=""
+else
+        SRC_URI="mirror://sourceforge/oyranos/Oyranos/Oyranos%200.4/${P}.tar.bz2"
+fi
 
 LICENSE="BSD"
 SLOT="0"
 KEYWORDS="~amd64 ~x86"
 IUSE="X cairo cups doc exif fltk qt4 raw test"
 
-RDEPEND=">=app-admin/elektra-0.8.3-r1
+RDEPEND="=app-admin/elektra-0.7*
 	dev-libs/libxml2
 	dev-libs/yajl
 	media-gfx/exiv2
+	media-libs/icc-profiles-basiccolor-printing2009
+	media-libs/icc-profiles-openicc
 	|| ( media-libs/lcms:0 media-libs/lcms:2 )
 	media-libs/libpng:0
 	media-libs/libraw
@@ -35,16 +44,32 @@
 	raw? ( media-libs/libraw )"
 DEPEND="${RDEPEND}
 	app-doc/doxygen
-	media-gfx/graphviz
-	test? ( media-libs/icc-profiles-basiccolor-printing2009
-		media-libs/icc-profiles-openicc )"
+	media-gfx/graphviz"
 
 #RESTRICT="test"
 
-CMAKE_REMOVE_MODULES_LIST="${CMAKE_REMOVE_MODULES_LIST} FindFltk FindElektra FindXcm FindCUPS"
+CMAKE_REMOVE_MODULES_LIST="${CMAKE_REMOVE_MODULES_LIST} FindFltk FindXcm FindCUPS"
 
 src_prepare() {
-	epatch "${FILESDIR}/${P}"-buildsystem.patch
+	epatch "${FILESDIR}/${P}"-buildsystem-r1.patch
+
+	#upstream(ed) fixes, be more verbose, better xrandr handling
+	epatch "${FILESDIR}/${P}"-fix-array-access.patch \
+		"${FILESDIR}/${P}"-fix-oyRankMap-helper-functions-crashes.patch \
+		"${FILESDIR}/${P}"-fix-oyStringSegment-crash.patch \
+		"${FILESDIR}/${P}"-be-more-verbose.patch \
+		"${FILESDIR}/${P}"-use-more-internal-xrandr-info.patch \
+		"${FILESDIR}/${P}"-set-xcalib-to-screen-if-ge-xrandr-12.patch \
+		"${FILESDIR}/${P}"-fix-double-object-release.patch \
+		"${FILESDIR}/${P}"-omit-profile-with-error.patch \
+		"${FILESDIR}/${P}"-fix-typos-and-grammar.patch
+
+	#upstream fix for QA notice, gentoo bug 464254
+	epatch "${FILESDIR}/${P}"-fix-runpaths.patch
+
+	#fix really ugly and prominently visible typo (solved in 0.9.5)
+	sed -e 's/Promt/Prompt/' \
+		-i src/liboyranos_config/oyranos_texts.c po/*.{po,pot} settings/*xml || die
 
 	if use fltk ; then
 		#src/examples does not include fltk flags
