--- a/samba-4.1.0-r1.ebuild	2013-10-29 15:31:25.000000000 +0100
+++ b/samba-4.1.0-r1.ebuild	2013-11-01 20:44:05.694848725 +0100
@@ -19,10 +19,9 @@
 
 SLOT="0"
 
-IUSE="acl addns ads aio avahi client cluster cups fam gnutls iprint
-ldap quota selinux syslog test winbind"
+IUSE="acl addns ads aio avahi client cluster cups dmapi fam gnutls
+iprint ldap quota selinux syslog test winbind"
 
-# sys-apps/dmapi is an automagic dependency (see bug #474492)
 # sys-apps/attr is an automagic dependency (see bug #489748)
 # dev-libs/libaio is an automagic dependency (see bug #489764)
 # sys-libs/pam is an automagic dependency (see bug #489770)
@@ -35,7 +34,6 @@
 	virtual/libiconv
 	dev-python/subunit
 	sys-apps/attr
-	sys-apps/dmapi
 	sys-libs/libcap
 	>=sys-libs/ldb-1.1.16
 	>=sys-libs/tdb-1.2.11[python]
@@ -47,6 +45,7 @@
 	addns? ( net-dns/bind-tools[gssapi] )
 	client? ( net-fs/cifs-utils[ads?] )
 	cluster? ( >=dev-db/ctdb-1.0.114_p1 )
+	dmapi? ( sys-apps/dmapi )
 	fam? ( virtual/fam )
 	gnutls? ( dev-libs/libgcrypt
 		>=net-libs/gnutls-1.4.0 )
@@ -81,6 +80,11 @@
 	fi
 }
 
+src_prepare() {
+	# sys-apps/dmapi is an automagic dependency (see bug #474492)
+	epatch "${FILESDIR}/${PN}-4.1.0-remove-dmapi-automagic.patch"
+}
+
 src_configure() {
 	local myconf=''
 	use "cluster" && myconf+=" --with-ctdb-dir=/usr"
@@ -105,6 +109,7 @@
 		$(use_enable avahi) \
 		$(use_with cluster cluster-support) \
 		$(use_enable cups) \
+		$(use_with dmapi) \
 		$(use_with fam) \
 		$(use_enable gnutls) \
 		$(use_enable iprint) \
