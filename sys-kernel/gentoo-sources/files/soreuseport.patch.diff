--- files/soreuseport.patch	2014-05-07 23:35:01.781034921 +0200
+++ files/3.4.89-backport-02-merge-branch-soreuseport.patch	2014-05-08 00:23:16.871841305 +0200
@@ -55,10 +55,10 @@
     
     Signed-off-by: David S. Miller <davem@davemloft.net>
 
-diff --git a/arch/alpha/include/uapi/asm/socket.h b/arch/alpha/include/uapi/asm/socket.h
+diff --git a/arch/alpha/include/asm/socket.h b/arch/alpha/include/uapi/asm/socket.h
 index 755702e..c519552 100644
---- a/arch/alpha/include/uapi/asm/socket.h
-+++ b/arch/alpha/include/uapi/asm/socket.h
+--- a/arch/alpha/include/asm/socket.h
++++ b/arch/alpha/include/asm/socket.h
 @@ -19,7 +19,7 @@
  #define SO_BROADCAST	0x0020
  #define SO_LINGER	0x0080
@@ -68,10 +68,8 @@
  
  #define SO_TYPE		0x1008
  #define SO_ERROR	0x1007
-diff --git a/arch/avr32/include/uapi/asm/socket.h b/arch/avr32/include/uapi/asm/socket.h
-index f3f38a0..51c6401 100644
---- a/arch/avr32/include/uapi/asm/socket.h
-+++ b/arch/avr32/include/uapi/asm/socket.h
+--- a/arch/avr32/include/asm/socket.h
++++ b/arch/avr32/include/asm/socket.h
 @@ -22,7 +22,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -81,10 +79,8 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/cris/include/uapi/asm/socket.h b/arch/cris/include/uapi/asm/socket.h
-index 406b583..50692b7 100644
---- a/arch/cris/include/uapi/asm/socket.h
-+++ b/arch/cris/include/uapi/asm/socket.h
+--- a/arch/cris/include/asm/socket.h
++++ b/arch/cris/include/asm/socket.h
 @@ -24,7 +24,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -94,10 +90,8 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/frv/include/uapi/asm/socket.h b/arch/frv/include/uapi/asm/socket.h
-index d8e1132..595391f 100644
---- a/arch/frv/include/uapi/asm/socket.h
-+++ b/arch/frv/include/uapi/asm/socket.h
+--- a/arch/frv/include/asm/socket.h
++++ b/arch/frv/include/asm/socket.h
 @@ -22,7 +22,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -107,10 +101,8 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/h8300/include/uapi/asm/socket.h b/arch/h8300/include/uapi/asm/socket.h
-index c8b87a8..43e3262 100644
---- a/arch/h8300/include/uapi/asm/socket.h
-+++ b/arch/h8300/include/uapi/asm/socket.h
+--- a/arch/h8300/include/asm/socket.h
++++ b/arch/h8300/include/asm/socket.h
 @@ -22,7 +22,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -120,10 +112,8 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/ia64/include/uapi/asm/socket.h b/arch/ia64/include/uapi/asm/socket.h
-index f390896..c567adc 100644
---- a/arch/ia64/include/uapi/asm/socket.h
-+++ b/arch/ia64/include/uapi/asm/socket.h
+--- a/arch/ia64/include/asm/socket.h
++++ b/arch/ia64/include/asm/socket.h
 @@ -31,7 +31,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -133,10 +123,8 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/m32r/include/uapi/asm/socket.h b/arch/m32r/include/uapi/asm/socket.h
-index 6a89515..519afa2 100644
---- a/arch/m32r/include/uapi/asm/socket.h
-+++ b/arch/m32r/include/uapi/asm/socket.h
+--- a/arch/m32r/include/asm/socket.h
++++ b/arch/m32r/include/asm/socket.h
 @@ -22,7 +22,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -146,10 +134,8 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/mips/include/uapi/asm/socket.h b/arch/mips/include/uapi/asm/socket.h
-index 9d11a77..7e27236 100644
---- a/arch/mips/include/uapi/asm/socket.h
-+++ b/arch/mips/include/uapi/asm/socket.h
+--- a/arch/mips/include/asm/socket.h
++++ b/arch/mips/include/asm/socket.h
 @@ -28,8 +28,7 @@
  #define SO_LINGER	0x0080	/* Block on close of a reliable
  				   socket to transmit pending data.  */
@@ -160,10 +146,8 @@
  #endif
  
  #define SO_TYPE		0x1008	/* Compatible name for SO_STYLE.  */
-diff --git a/arch/mn10300/include/uapi/asm/socket.h b/arch/mn10300/include/uapi/asm/socket.h
-index ab702c4..5c7c7c9 100644
---- a/arch/mn10300/include/uapi/asm/socket.h
-+++ b/arch/mn10300/include/uapi/asm/socket.h
+--- a/arch/mn10300/include/asm/socket.h
++++ b/arch/mn10300/include/asm/socket.h
 @@ -22,7 +22,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -173,10 +157,8 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/parisc/include/uapi/asm/socket.h b/arch/parisc/include/uapi/asm/socket.h
-index da2c8d3..526e4b9 100644
---- a/arch/parisc/include/uapi/asm/socket.h
-+++ b/arch/parisc/include/uapi/asm/socket.h
+--- a/arch/parisc/include/asm/socket.h
++++ b/arch/parisc/include/asm/socket.h
 @@ -13,7 +13,7 @@
  #define SO_BROADCAST	0x0020
  #define SO_LINGER	0x0080
@@ -186,10 +168,8 @@
  #define SO_SNDBUF	0x1001
  #define SO_RCVBUF	0x1002
  #define SO_SNDBUFFORCE	0x100a
-diff --git a/arch/powerpc/include/uapi/asm/socket.h b/arch/powerpc/include/uapi/asm/socket.h
-index e6ca318..a26dcae 100644
---- a/arch/powerpc/include/uapi/asm/socket.h
-+++ b/arch/powerpc/include/uapi/asm/socket.h
+--- a/arch/powerpc/include/asm/socket.h
++++ b/arch/powerpc/include/asm/socket.h
 @@ -29,7 +29,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -199,10 +179,8 @@
  #define SO_RCVLOWAT	16
  #define SO_SNDLOWAT	17
  #define SO_RCVTIMEO	18
-diff --git a/arch/s390/include/uapi/asm/socket.h b/arch/s390/include/uapi/asm/socket.h
-index 9ce60b6..f99eea7 100644
---- a/arch/s390/include/uapi/asm/socket.h
-+++ b/arch/s390/include/uapi/asm/socket.h
+--- a/arch/s390/include/asm/socket.h
++++ b/arch/s390/include/asm/socket.h
 @@ -28,7 +28,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -212,10 +190,8 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/sparc/include/uapi/asm/socket.h b/arch/sparc/include/uapi/asm/socket.h
-index fbbba57..cbbad74 100644
---- a/arch/sparc/include/uapi/asm/socket.h
-+++ b/arch/sparc/include/uapi/asm/socket.h
+--- a/arch/sparc/include/asm/socket.h
++++ b/arch/sparc/include/asm/socket.h
 @@ -15,7 +15,7 @@
  #define SO_PEERCRED	0x0040
  #define SO_LINGER	0x0080
@@ -225,10 +201,8 @@
  #define SO_BSDCOMPAT    0x0400
  #define SO_RCVLOWAT     0x0800
  #define SO_SNDLOWAT     0x1000
-diff --git a/arch/xtensa/include/uapi/asm/socket.h b/arch/xtensa/include/uapi/asm/socket.h
-index dbf3164..35905cb 100644
---- a/arch/xtensa/include/uapi/asm/socket.h
-+++ b/arch/xtensa/include/uapi/asm/socket.h
+--- a/arch/xtensa/include/asm/socket.h
++++ b/arch/xtensa/include/asm/socket.h
 @@ -32,7 +32,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -238,8 +212,6 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/include/linux/random.h b/include/linux/random.h
-index d984608..347ce55 100644
 --- a/include/linux/random.h
 +++ b/include/linux/random.h
 @@ -74,4 +74,10 @@ static inline int arch_get_random_int(unsigned int *v)
@@ -253,8 +225,6 @@
 +}
 +
  #endif /* _LINUX_RANDOM_H */
-diff --git a/include/net/inet6_hashtables.h b/include/net/inet6_hashtables.h
-index 9e34c87..7ca75cb 100644
 --- a/include/net/inet6_hashtables.h
 +++ b/include/net/inet6_hashtables.h
 @@ -71,6 +71,8 @@ extern struct sock *__inet6_lookup_established(struct net *net,
@@ -276,8 +246,6 @@
  }
  
  static inline struct sock *__inet6_lookup_skb(struct inet_hashinfo *hashinfo,
-diff --git a/include/net/inet_hashtables.h b/include/net/inet_hashtables.h
-index 67a8fa0..7b2ae9d 100644
 --- a/include/net/inet_hashtables.h
 +++ b/include/net/inet_hashtables.h
 @@ -81,7 +81,9 @@ struct inet_bind_bucket {
@@ -287,7 +255,7 @@
 -	signed short		fastreuse;
 +	signed char		fastreuse;
 +	signed char		fastreuseport;
-+	kuid_t			fastuid;
++	int			fastuid;
  	int			num_owners;
  	struct hlist_node	node;
  	struct hlist_head	owners;
@@ -322,8 +290,6 @@
  }
  
  static inline struct sock *inet_lookup(struct net *net,
-diff --git a/include/net/netfilter/nf_tproxy_core.h b/include/net/netfilter/nf_tproxy_core.h
-index 75ca929..36d9379 100644
 --- a/include/net/netfilter/nf_tproxy_core.h
 +++ b/include/net/netfilter/nf_tproxy_core.h
 @@ -82,6 +82,7 @@ nf_tproxy_get_sock_v4(struct net *net, const u8 protocol,
@@ -342,8 +308,6 @@
  						   daddr, ntohs(dport),
  						   in->ifindex);
  
-diff --git a/include/net/sock.h b/include/net/sock.h
-index 5a34e2f..581dc6b 100644
 --- a/include/net/sock.h
 +++ b/include/net/sock.h
 @@ -140,6 +140,7 @@ typedef __u64 __bitwise __addrpair;
@@ -372,10 +336,8 @@
  #define sk_bound_dev_if		__sk_common.skc_bound_dev_if
  #define sk_bind_node		__sk_common.skc_bind_node
  #define sk_prot			__sk_common.skc_prot
-diff --git a/include/uapi/asm-generic/socket.h b/include/uapi/asm-generic/socket.h
-index 3f6a992..4ef3acb 100644
---- a/include/uapi/asm-generic/socket.h
-+++ b/include/uapi/asm-generic/socket.h
+--- a/include/asm-generic/socket.h
++++ b/include/asm-generic/socket.h
 @@ -22,8 +22,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -386,8 +348,6 @@
  #ifndef SO_PASSCRED /* powerpc only differs in these */
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
-diff --git a/net/core/sock.c b/net/core/sock.c
-index 8258fb7..235fb89 100644
 --- a/net/core/sock.c
 +++ b/net/core/sock.c
 @@ -665,6 +665,9 @@ int sock_setsockopt(struct socket *sock, int level, int optname,
@@ -411,8 +371,6 @@
  	case SO_KEEPALIVE:
  		v.val = sock_flag(sk, SOCK_KEEPOPEN);
  		break;
-diff --git a/net/ipv4/inet_connection_sock.c b/net/ipv4/inet_connection_sock.c
-index d0670f0..8bb623d 100644
 --- a/net/ipv4/inet_connection_sock.c
 +++ b/net/ipv4/inet_connection_sock.c
 @@ -59,6 +59,8 @@ int inet_csk_bind_conflict(const struct sock *sk,
@@ -420,7 +378,7 @@
  	struct hlist_node *node;
  	int reuse = sk->sk_reuse;
 +	int reuseport = sk->sk_reuseport;
-+	kuid_t uid = sock_i_uid((struct sock *)sk);
++	int uid = sock_i_uid((struct sock *)sk);
  
  	/*
  	 * Unlike other sk lookup places we do not check
@@ -434,7 +392,7 @@
 +			    sk2->sk_state == TCP_LISTEN) &&
 +			    (!reuseport || !sk2->sk_reuseport ||
 +			    (sk2->sk_state != TCP_TIME_WAIT &&
-+			     !uid_eq(uid, sock_i_uid(sk2))))) {
++			     uid != sock_i_uid(sk2)))) {
  				const __be32 sk2_rcv_saddr = sk_rcv_saddr(sk2);
  				if (!sk2_rcv_saddr || !sk_rcv_saddr(sk) ||
  				    sk2_rcv_saddr == sk_rcv_saddr(sk))
@@ -442,7 +400,7 @@
  	int ret, attempts = 5;
  	struct net *net = sock_net(sk);
  	int smallest_size = -1, smallest_rover;
-+	kuid_t uid = sock_i_uid(sk);
++	int uid = sock_i_uid(sk);
  
  	local_bh_disable();
  	if (!snum) {
@@ -458,7 +416,7 @@
 +					      sk->sk_state != TCP_LISTEN) ||
 +					     (tb->fastreuseport > 0 &&
 +					      sk->sk_reuseport &&
-+					      uid_eq(tb->fastuid, uid))) &&
++					      tb->fastuid == uid)) &&
  					    (tb->num_owners < smallest_size || smallest_size == -1)) {
  						smallest_size = tb->num_owners;
  						smallest_rover = rover;
@@ -471,15 +429,15 @@
 +		if (((tb->fastreuse > 0 &&
 +		      sk->sk_reuse && sk->sk_state != TCP_LISTEN) ||
 +		     (tb->fastreuseport > 0 &&
-+		      sk->sk_reuseport && uid_eq(tb->fastuid, uid))) &&
++		      sk->sk_reuseport && tb->fastuid == uid)) &&
  		    smallest_size == -1) {
  			goto success;
  		} else {
  			ret = 1;
- 			if (inet_csk(sk)->icsk_af_ops->bind_conflict(sk, tb, true)) {
+ 			if (inet_csk(sk)->icsk_af_ops->bind_conflict(sk, tb)) {
 -				if (sk->sk_reuse && sk->sk_state != TCP_LISTEN &&
 +				if (((sk->sk_reuse && sk->sk_state != TCP_LISTEN) ||
-+				     (sk->sk_reuseport && uid_eq(tb->fastuid, uid))) &&
++				     (sk->sk_reuseport && tb->fastuid == uid)) &&
  				    smallest_size != -1 && --attempts >= 0) {
  					spin_unlock(&head->lock);
  					goto again;
@@ -502,7 +460,7 @@
 +		    (!sk->sk_reuse || sk->sk_state == TCP_LISTEN))
 +			tb->fastreuse = 0;
 +		if (tb->fastreuseport &&
-+		    (!sk->sk_reuseport || !uid_eq(tb->fastuid, uid))) {
++		    (!sk->sk_reuseport || tb->fastuid != uid)) {
 +			tb->fastreuseport = 0;
 +			tb->fastuid = 0;
 +		}
@@ -510,8 +468,6 @@
  success:
  	if (!inet_csk(sk)->icsk_bind_hash)
  		inet_bind_hash(sk, tb, snum);
-diff --git a/net/ipv4/inet_hashtables.c b/net/ipv4/inet_hashtables.c
-index fa3ae81..0ce0595 100644
 --- a/net/ipv4/inet_hashtables.c
 +++ b/net/ipv4/inet_hashtables.c
 @@ -39,6 +39,7 @@ struct inet_bind_bucket *inet_bind_bucket_create(struct kmem_cache *cachep,
@@ -600,8 +556,6 @@
  			goto ok;
  
  		next_port:
-diff --git a/net/ipv4/tcp_ipv4.c b/net/ipv4/tcp_ipv4.c
-index c6ce9ca..bbbdcc5 100644
 --- a/net/ipv4/tcp_ipv4.c
 +++ b/net/ipv4/tcp_ipv4.c
 @@ -657,7 +657,8 @@ static void tcp_v4_send_reset(struct sock *sk, struct sk_buff *skb)
@@ -622,15 +576,13 @@
  							iph->daddr, th->dest,
  							inet_iif(skb));
  		if (sk2) {
-diff --git a/net/ipv4/udp.c b/net/ipv4/udp.c
-index cf6158f..e0610e4 100644
 --- a/net/ipv4/udp.c
 +++ b/net/ipv4/udp.c
 @@ -139,6 +139,7 @@ static int udp_lib_lport_inuse(struct net *net, __u16 num,
  {
  	struct sock *sk2;
  	struct hlist_nulls_node *node;
-+	kuid_t uid = sock_i_uid(sk);
++	int uid = sock_i_uid(sk);
  
  	sk_nulls_for_each(sk2, node, &hslot->head)
  		if (net_eq(sock_net(sk2), net) &&
@@ -639,7 +591,7 @@
  		    (!sk2->sk_bound_dev_if || !sk->sk_bound_dev_if ||
  		     sk2->sk_bound_dev_if == sk->sk_bound_dev_if) &&
 +		    (!sk2->sk_reuseport || !sk->sk_reuseport ||
-+		      !uid_eq(uid, sock_i_uid(sk2))) &&
++		      uid != sock_i_uid(sk2)) &&
  		    (*saddr_comp)(sk, sk2)) {
  			if (bitmap)
  				__set_bit(udp_sk(sk2)->udp_port_hash >> log,
@@ -647,7 +599,7 @@
  {
  	struct sock *sk2;
  	struct hlist_nulls_node *node;
-+	kuid_t uid = sock_i_uid(sk);
++	int uid = sock_i_uid(sk);
  	int res = 0;
  
  	spin_lock(&hslot2->lock);
@@ -656,7 +608,7 @@
  		    (!sk2->sk_bound_dev_if || !sk->sk_bound_dev_if ||
  		     sk2->sk_bound_dev_if == sk->sk_bound_dev_if) &&
 +		    (!sk2->sk_reuseport || !sk->sk_reuseport ||
-+		      !uid_eq(uid, sock_i_uid(sk2))) &&
++		      uid != sock_i_uid(sk2)) &&
  		    (*saddr_comp)(sk, sk2)) {
  			res = 1;
  			break;
@@ -806,8 +758,6 @@
  		}
  	}
  	/*
-diff --git a/net/ipv6/inet6_connection_sock.c b/net/ipv6/inet6_connection_sock.c
-index 3064785..e4297a3 100644
 --- a/net/ipv6/inet6_connection_sock.c
 +++ b/net/ipv6/inet6_connection_sock.c
 @@ -32,6 +32,9 @@ int inet6_csk_bind_conflict(const struct sock *sk,
@@ -820,7 +770,7 @@
  
  	/* We must walk the whole port owner list in this case. -DaveM */
  	/*
-@@ -42,11 +45,17 @@ int inet6_csk_bind_conflict(const struct sock *sk,
+@@ -42,11 +45,16 @@ int inet6_csk_bind_conflict(const struct sock *sk,
  		if (sk != sk2 &&
  		    (!sk->sk_bound_dev_if ||
  		     !sk2->sk_bound_dev_if ||
@@ -834,8 +784,7 @@
 +			     sk2->sk_state == TCP_LISTEN) &&
 +			    (!reuseport || !sk2->sk_reuseport ||
 +			     (sk2->sk_state != TCP_TIME_WAIT &&
-+			      !uid_eq(uid,
-+				      sock_i_uid((struct sock *)sk2))))) {
++			      uid != sock_i_uid((struct sock *)sk2)))) {
 +				if (ipv6_rcv_saddr_equal(sk, sk2))
 +					break;
 +			}
@@ -844,7 +793,6 @@
  
  	return node != NULL;
 diff --git a/net/ipv6/inet6_hashtables.c b/net/ipv6/inet6_hashtables.c
-index dea17fd..32b4a16 100644
 --- a/net/ipv6/inet6_hashtables.c
 +++ b/net/ipv6/inet6_hashtables.c
 @@ -158,25 +158,38 @@ static inline int compute_score(struct sock *sk, struct net *net,
@@ -889,8 +837,6 @@
  		}
  	}
  	/*
-diff --git a/net/ipv6/tcp_ipv6.c b/net/ipv6/tcp_ipv6.c
-index 3701c3c..06087e5 100644
 --- a/net/ipv6/tcp_ipv6.c
 +++ b/net/ipv6/tcp_ipv6.c
 @@ -834,7 +834,8 @@ static void tcp_v6_send_reset(struct sock *sk, struct sk_buff *skb)
@@ -911,8 +857,6 @@
  					    &ipv6_hdr(skb)->daddr,
  					    ntohs(th->dest), inet6_iif(skb));
  		if (sk2 != NULL) {
-diff --git a/net/ipv6/udp.c b/net/ipv6/udp.c
-index 1afb635..cb5bf49 100644
 --- a/net/ipv6/udp.c
 +++ b/net/ipv6/udp.c
 @@ -45,6 +45,7 @@
