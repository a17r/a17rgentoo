--- files/soreuseport.patch	2014-05-07 23:35:01.781034921 +0200
+++ files/3.4.89-backport-02-merge-branch-soreuseport.patch	2014-05-07 23:30:39.571312995 +0200
@@ -55,10 +55,10 @@
     
     Signed-off-by: David S. Miller <davem@davemloft.net>
 
-diff --git a/arch/alpha/include/uapi/asm/socket.h b/arch/alpha/include/uapi/asm/socket.h
+diff --git a/arch/alpha/include/asm/socket.h b/arch/alpha/include/uapi/asm/socket.h
 index 755702e..c519552 100644
---- a/arch/alpha/include/uapi/asm/socket.h
-+++ b/arch/alpha/include/uapi/asm/socket.h
+--- a/arch/alpha/include/asm/socket.h
++++ b/arch/alpha/include/asm/socket.h
 @@ -19,7 +19,7 @@
  #define SO_BROADCAST	0x0020
  #define SO_LINGER	0x0080
@@ -68,10 +68,9 @@
  
  #define SO_TYPE		0x1008
  #define SO_ERROR	0x1007
-diff --git a/arch/avr32/include/uapi/asm/socket.h b/arch/avr32/include/uapi/asm/socket.h
-index f3f38a0..51c6401 100644
---- a/arch/avr32/include/uapi/asm/socket.h
-+++ b/arch/avr32/include/uapi/asm/socket.h
+diff --git a/arch/avr32/include/asm/socket.h b/arch/avr32/include/uapi/asm/socket.h
+--- a/arch/avr32/include/asm/socket.h
++++ b/arch/avr32/include/asm/socket.h
 @@ -22,7 +22,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -81,10 +80,9 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/cris/include/uapi/asm/socket.h b/arch/cris/include/uapi/asm/socket.h
-index 406b583..50692b7 100644
---- a/arch/cris/include/uapi/asm/socket.h
-+++ b/arch/cris/include/uapi/asm/socket.h
+diff --git a/arch/cris/include/asm/socket.h b/arch/cris/include/uapi/asm/socket.h
+--- a/arch/cris/include/asm/socket.h
++++ b/arch/cris/include/asm/socket.h
 @@ -24,7 +24,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -94,10 +92,9 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/frv/include/uapi/asm/socket.h b/arch/frv/include/uapi/asm/socket.h
-index d8e1132..595391f 100644
---- a/arch/frv/include/uapi/asm/socket.h
-+++ b/arch/frv/include/uapi/asm/socket.h
+diff --git a/arch/frv/include/asm/socket.h b/arch/frv/include/uapi/asm/socket.h
+--- a/arch/frv/include/asm/socket.h
++++ b/arch/frv/include/asm/socket.h
 @@ -22,7 +22,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -107,10 +104,9 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/h8300/include/uapi/asm/socket.h b/arch/h8300/include/uapi/asm/socket.h
-index c8b87a8..43e3262 100644
---- a/arch/h8300/include/uapi/asm/socket.h
-+++ b/arch/h8300/include/uapi/asm/socket.h
+diff --git a/arch/h8300/include/asm/socket.h b/arch/h8300/include/uapi/asm/socket.h
+--- a/arch/h8300/include/asm/socket.h
++++ b/arch/h8300/include/asm/socket.h
 @@ -22,7 +22,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -120,10 +116,9 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/ia64/include/uapi/asm/socket.h b/arch/ia64/include/uapi/asm/socket.h
-index f390896..c567adc 100644
---- a/arch/ia64/include/uapi/asm/socket.h
-+++ b/arch/ia64/include/uapi/asm/socket.h
+diff --git a/arch/ia64/include/asm/socket.h b/arch/ia64/include/uapi/asm/socket.h
+--- a/arch/ia64/include/asm/socket.h
++++ b/arch/ia64/include/asm/socket.h
 @@ -31,7 +31,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -133,10 +128,9 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/m32r/include/uapi/asm/socket.h b/arch/m32r/include/uapi/asm/socket.h
-index 6a89515..519afa2 100644
---- a/arch/m32r/include/uapi/asm/socket.h
-+++ b/arch/m32r/include/uapi/asm/socket.h
+diff --git a/arch/m32r/include/asm/socket.h b/arch/m32r/include/uapi/asm/socket.h
+--- a/arch/m32r/include/asm/socket.h
++++ b/arch/m32r/include/asm/socket.h
 @@ -22,7 +22,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -146,10 +140,9 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/mips/include/uapi/asm/socket.h b/arch/mips/include/uapi/asm/socket.h
-index 9d11a77..7e27236 100644
---- a/arch/mips/include/uapi/asm/socket.h
-+++ b/arch/mips/include/uapi/asm/socket.h
+diff --git a/arch/mips/include/asm/socket.h b/arch/mips/include/uapi/asm/socket.h
+--- a/arch/mips/include/asm/socket.h
++++ b/arch/mips/include/asm/socket.h
 @@ -28,8 +28,7 @@
  #define SO_LINGER	0x0080	/* Block on close of a reliable
  				   socket to transmit pending data.  */
@@ -160,10 +153,9 @@
  #endif
  
  #define SO_TYPE		0x1008	/* Compatible name for SO_STYLE.  */
-diff --git a/arch/mn10300/include/uapi/asm/socket.h b/arch/mn10300/include/uapi/asm/socket.h
-index ab702c4..5c7c7c9 100644
---- a/arch/mn10300/include/uapi/asm/socket.h
-+++ b/arch/mn10300/include/uapi/asm/socket.h
+diff --git a/arch/mn10300/include/asm/socket.h b/arch/mn10300/include/uapi/asm/socket.h
+--- a/arch/mn10300/include/asm/socket.h
++++ b/arch/mn10300/include/asm/socket.h
 @@ -22,7 +22,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -173,10 +165,9 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/parisc/include/uapi/asm/socket.h b/arch/parisc/include/uapi/asm/socket.h
-index da2c8d3..526e4b9 100644
---- a/arch/parisc/include/uapi/asm/socket.h
-+++ b/arch/parisc/include/uapi/asm/socket.h
+diff --git a/arch/parisc/include/asm/socket.h b/arch/parisc/include/uapi/asm/socket.h
+--- a/arch/parisc/include/asm/socket.h
++++ b/arch/parisc/include/asm/socket.h
 @@ -13,7 +13,7 @@
  #define SO_BROADCAST	0x0020
  #define SO_LINGER	0x0080
@@ -186,10 +177,9 @@
  #define SO_SNDBUF	0x1001
  #define SO_RCVBUF	0x1002
  #define SO_SNDBUFFORCE	0x100a
-diff --git a/arch/powerpc/include/uapi/asm/socket.h b/arch/powerpc/include/uapi/asm/socket.h
-index e6ca318..a26dcae 100644
---- a/arch/powerpc/include/uapi/asm/socket.h
-+++ b/arch/powerpc/include/uapi/asm/socket.h
+diff --git a/arch/powerpc/include/asm/socket.h b/arch/powerpc/include/uapi/asm/socket.h
+--- a/arch/powerpc/include/asm/socket.h
++++ b/arch/powerpc/include/asm/socket.h
 @@ -29,7 +29,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -199,10 +189,9 @@
  #define SO_RCVLOWAT	16
  #define SO_SNDLOWAT	17
  #define SO_RCVTIMEO	18
-diff --git a/arch/s390/include/uapi/asm/socket.h b/arch/s390/include/uapi/asm/socket.h
-index 9ce60b6..f99eea7 100644
---- a/arch/s390/include/uapi/asm/socket.h
-+++ b/arch/s390/include/uapi/asm/socket.h
+diff --git a/arch/s390/include/asm/socket.h b/arch/s390/include/uapi/asm/socket.h
+--- a/arch/s390/include/asm/socket.h
++++ b/arch/s390/include/asm/socket.h
 @@ -28,7 +28,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -212,10 +201,9 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
-diff --git a/arch/sparc/include/uapi/asm/socket.h b/arch/sparc/include/uapi/asm/socket.h
-index fbbba57..cbbad74 100644
---- a/arch/sparc/include/uapi/asm/socket.h
-+++ b/arch/sparc/include/uapi/asm/socket.h
+diff --git a/arch/sparc/include/asm/socket.h b/arch/sparc/include/uapi/asm/socket.h
+--- a/arch/sparc/include/asm/socket.h
++++ b/arch/sparc/include/asm/socket.h
 @@ -15,7 +15,7 @@
  #define SO_PEERCRED	0x0040
  #define SO_LINGER	0x0080
@@ -225,10 +213,9 @@
  #define SO_BSDCOMPAT    0x0400
  #define SO_RCVLOWAT     0x0800
  #define SO_SNDLOWAT     0x1000
-diff --git a/arch/xtensa/include/uapi/asm/socket.h b/arch/xtensa/include/uapi/asm/socket.h
-index dbf3164..35905cb 100644
---- a/arch/xtensa/include/uapi/asm/socket.h
-+++ b/arch/xtensa/include/uapi/asm/socket.h
+diff --git a/arch/xtensa/include/asm/socket.h b/arch/xtensa/include/uapi/asm/socket.h
+--- a/arch/xtensa/include/asm/socket.h
++++ b/arch/xtensa/include/asm/socket.h
 @@ -32,7 +32,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -239,7 +226,6 @@
  #define SO_PEERCRED	17
  #define SO_RCVLOWAT	18
 diff --git a/include/linux/random.h b/include/linux/random.h
-index d984608..347ce55 100644
 --- a/include/linux/random.h
 +++ b/include/linux/random.h
 @@ -74,4 +74,10 @@ static inline int arch_get_random_int(unsigned int *v)
@@ -254,7 +240,6 @@
 +
  #endif /* _LINUX_RANDOM_H */
 diff --git a/include/net/inet6_hashtables.h b/include/net/inet6_hashtables.h
-index 9e34c87..7ca75cb 100644
 --- a/include/net/inet6_hashtables.h
 +++ b/include/net/inet6_hashtables.h
 @@ -71,6 +71,8 @@ extern struct sock *__inet6_lookup_established(struct net *net,
@@ -277,7 +262,6 @@
  
  static inline struct sock *__inet6_lookup_skb(struct inet_hashinfo *hashinfo,
 diff --git a/include/net/inet_hashtables.h b/include/net/inet_hashtables.h
-index 67a8fa0..7b2ae9d 100644
 --- a/include/net/inet_hashtables.h
 +++ b/include/net/inet_hashtables.h
 @@ -81,7 +81,9 @@ struct inet_bind_bucket {
@@ -287,7 +271,7 @@
 -	signed short		fastreuse;
 +	signed char		fastreuse;
 +	signed char		fastreuseport;
-+	kuid_t			fastuid;
++	int			fastuid;
  	int			num_owners;
  	struct hlist_node	node;
  	struct hlist_head	owners;
@@ -323,7 +307,6 @@
  
  static inline struct sock *inet_lookup(struct net *net,
 diff --git a/include/net/netfilter/nf_tproxy_core.h b/include/net/netfilter/nf_tproxy_core.h
-index 75ca929..36d9379 100644
 --- a/include/net/netfilter/nf_tproxy_core.h
 +++ b/include/net/netfilter/nf_tproxy_core.h
 @@ -82,6 +82,7 @@ nf_tproxy_get_sock_v4(struct net *net, const u8 protocol,
@@ -343,7 +326,6 @@
  						   in->ifindex);
  
 diff --git a/include/net/sock.h b/include/net/sock.h
-index 5a34e2f..581dc6b 100644
 --- a/include/net/sock.h
 +++ b/include/net/sock.h
 @@ -140,6 +140,7 @@ typedef __u64 __bitwise __addrpair;
@@ -372,10 +354,9 @@
  #define sk_bound_dev_if		__sk_common.skc_bound_dev_if
  #define sk_bind_node		__sk_common.skc_bind_node
  #define sk_prot			__sk_common.skc_prot
-diff --git a/include/uapi/asm-generic/socket.h b/include/uapi/asm-generic/socket.h
-index 3f6a992..4ef3acb 100644
---- a/include/uapi/asm-generic/socket.h
-+++ b/include/uapi/asm-generic/socket.h
+diff --git a/include/asm-generic/socket.h b/include/uapi/asm-generic/socket.h
+--- a/include/asm-generic/socket.h
++++ b/include/asm-generic/socket.h
 @@ -22,8 +22,7 @@
  #define SO_PRIORITY	12
  #define SO_LINGER	13
@@ -387,7 +368,6 @@
  #define SO_PASSCRED	16
  #define SO_PEERCRED	17
 diff --git a/net/core/sock.c b/net/core/sock.c
-index 8258fb7..235fb89 100644
 --- a/net/core/sock.c
 +++ b/net/core/sock.c
 @@ -665,6 +665,9 @@ int sock_setsockopt(struct socket *sock, int level, int optname,
@@ -412,7 +392,6 @@
  		v.val = sock_flag(sk, SOCK_KEEPOPEN);
  		break;
 diff --git a/net/ipv4/inet_connection_sock.c b/net/ipv4/inet_connection_sock.c
-index d0670f0..8bb623d 100644
 --- a/net/ipv4/inet_connection_sock.c
 +++ b/net/ipv4/inet_connection_sock.c
 @@ -59,6 +59,8 @@ int inet_csk_bind_conflict(const struct sock *sk,
@@ -420,7 +399,7 @@
  	struct hlist_node *node;
  	int reuse = sk->sk_reuse;
 +	int reuseport = sk->sk_reuseport;
-+	kuid_t uid = sock_i_uid((struct sock *)sk);
++	int uid = sock_i_uid((struct sock *)sk);
  
  	/*
  	 * Unlike other sk lookup places we do not check
@@ -442,7 +421,7 @@
  	int ret, attempts = 5;
  	struct net *net = sock_net(sk);
  	int smallest_size = -1, smallest_rover;
-+	kuid_t uid = sock_i_uid(sk);
++	int uid = sock_i_uid(sk);
  
  	local_bh_disable();
  	if (!snum) {
@@ -476,7 +455,7 @@
  			goto success;
  		} else {
  			ret = 1;
- 			if (inet_csk(sk)->icsk_af_ops->bind_conflict(sk, tb, true)) {
+ 			if (inet_csk(sk)->icsk_af_ops->bind_conflict(sk, tb)) {
 -				if (sk->sk_reuse && sk->sk_state != TCP_LISTEN &&
 +				if (((sk->sk_reuse && sk->sk_state != TCP_LISTEN) ||
 +				     (sk->sk_reuseport && uid_eq(tb->fastuid, uid))) &&
@@ -511,7 +490,6 @@
  	if (!inet_csk(sk)->icsk_bind_hash)
  		inet_bind_hash(sk, tb, snum);
 diff --git a/net/ipv4/inet_hashtables.c b/net/ipv4/inet_hashtables.c
-index fa3ae81..0ce0595 100644
 --- a/net/ipv4/inet_hashtables.c
 +++ b/net/ipv4/inet_hashtables.c
 @@ -39,6 +39,7 @@ struct inet_bind_bucket *inet_bind_bucket_create(struct kmem_cache *cachep,
@@ -601,7 +579,6 @@
  
  		next_port:
 diff --git a/net/ipv4/tcp_ipv4.c b/net/ipv4/tcp_ipv4.c
-index c6ce9ca..bbbdcc5 100644
 --- a/net/ipv4/tcp_ipv4.c
 +++ b/net/ipv4/tcp_ipv4.c
 @@ -657,7 +657,8 @@ static void tcp_v4_send_reset(struct sock *sk, struct sk_buff *skb)
@@ -623,14 +600,13 @@
  							inet_iif(skb));
  		if (sk2) {
 diff --git a/net/ipv4/udp.c b/net/ipv4/udp.c
-index cf6158f..e0610e4 100644
 --- a/net/ipv4/udp.c
 +++ b/net/ipv4/udp.c
 @@ -139,6 +139,7 @@ static int udp_lib_lport_inuse(struct net *net, __u16 num,
  {
  	struct sock *sk2;
  	struct hlist_nulls_node *node;
-+	kuid_t uid = sock_i_uid(sk);
++	int uid = sock_i_uid(sk);
  
  	sk_nulls_for_each(sk2, node, &hslot->head)
  		if (net_eq(sock_net(sk2), net) &&
@@ -647,7 +623,7 @@
  {
  	struct sock *sk2;
  	struct hlist_nulls_node *node;
-+	kuid_t uid = sock_i_uid(sk);
++	int uid = sock_i_uid(sk);
  	int res = 0;
  
  	spin_lock(&hslot2->lock);
@@ -807,7 +783,6 @@
  	}
  	/*
 diff --git a/net/ipv6/inet6_connection_sock.c b/net/ipv6/inet6_connection_sock.c
-index 3064785..e4297a3 100644
 --- a/net/ipv6/inet6_connection_sock.c
 +++ b/net/ipv6/inet6_connection_sock.c
 @@ -32,6 +32,9 @@ int inet6_csk_bind_conflict(const struct sock *sk,
@@ -844,7 +819,6 @@
  
  	return node != NULL;
 diff --git a/net/ipv6/inet6_hashtables.c b/net/ipv6/inet6_hashtables.c
-index dea17fd..32b4a16 100644
 --- a/net/ipv6/inet6_hashtables.c
 +++ b/net/ipv6/inet6_hashtables.c
 @@ -158,25 +158,38 @@ static inline int compute_score(struct sock *sk, struct net *net,
@@ -890,7 +864,6 @@
  	}
  	/*
 diff --git a/net/ipv6/tcp_ipv6.c b/net/ipv6/tcp_ipv6.c
-index 3701c3c..06087e5 100644
 --- a/net/ipv6/tcp_ipv6.c
 +++ b/net/ipv6/tcp_ipv6.c
 @@ -834,7 +834,8 @@ static void tcp_v6_send_reset(struct sock *sk, struct sk_buff *skb)
@@ -912,7 +885,6 @@
  					    ntohs(th->dest), inet6_iif(skb));
  		if (sk2 != NULL) {
 diff --git a/net/ipv6/udp.c b/net/ipv6/udp.c
-index 1afb635..cb5bf49 100644
 --- a/net/ipv6/udp.c
 +++ b/net/ipv6/udp.c
 @@ -45,6 +45,7 @@
