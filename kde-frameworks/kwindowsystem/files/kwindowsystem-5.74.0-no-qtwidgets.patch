From dce3029c986982fc9d2edb93dbf8d24e2aff1bf3 Mon Sep 17 00:00:00 2001
From: Andreas Sturmlechner <asturm@gentoo.org>
Date: Wed, 30 Sep 2020 00:42:28 +0200
Subject: [PATCH] Remove Qt5::Widgets as dependency

---
 CMakeLists.txt                 |  9 +++++++--
 KF5WindowSystemConfig.cmake.in |  3 +--
 autotests/CMakeLists.txt       | 22 ++++++++++++++--------
 3 files changed, 22 insertions(+), 12 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 23f46c0..5bed1f9 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -47,7 +47,10 @@ ecm_setup_version(PROJECT VARIABLE_PREFIX KWINDOWSYSTEM
 
 # Dependencies
 set(REQUIRED_QT_VERSION 5.12.0)
-find_package(Qt5 ${REQUIRED_QT_VERSION} CONFIG REQUIRED Gui Widgets)
+find_package(Qt5Gui ${REQUIRED_QT_VERSION} CONFIG REQUIRED)
+if(NOT KWINDOWSYSTEM_NO_WIDGETS)
+    find_package(Qt5Widgets ${REQUIRED_QT_VERSION} CONFIG REQUIRED)
+endif()
 
 if (APPLE)
     cmake_find_frameworks(Carbon)
@@ -85,7 +88,9 @@ add_definitions(-DQT_DISABLE_DEPRECATED_BEFORE=0x050d00)
 add_subdirectory(src)
 if (BUILD_TESTING)
     add_subdirectory(autotests)
-    add_subdirectory(tests)
+    if(NOT KWINDOWSYSTEM_NO_WIDGETS)
+        add_subdirectory(tests)
+    endif()
 endif()
 
 # create a Config.cmake and a ConfigVersion.cmake file and install them
diff --git a/KF5WindowSystemConfig.cmake.in b/KF5WindowSystemConfig.cmake.in
index 8267ef4..c66daa5 100644
--- a/KF5WindowSystemConfig.cmake.in
+++ b/KF5WindowSystemConfig.cmake.in
@@ -1,8 +1,7 @@
 @PACKAGE_INIT@
 
 include(CMakeFindDependencyMacro)
-find_dependency(Qt5Widgets @REQUIRED_QT_VERSION@)
-
+find_dependency(Qt5Gui @REQUIRED_QT_VERSION@)
 
 include("${CMAKE_CURRENT_LIST_DIR}/KF5WindowSystemTargets.cmake")
 @PACKAGE_INCLUDE_QCHTARGETS@
diff --git a/autotests/CMakeLists.txt b/autotests/CMakeLists.txt
index c1121a7..51ed0c1 100644
--- a/autotests/CMakeLists.txt
+++ b/autotests/CMakeLists.txt
@@ -17,10 +17,13 @@ endif()
 
 macro(KWINDOWSYSTEM_UNIT_TESTS)
    foreach(_testname ${ARGN})
-      set(libs KF5::WindowSystem Qt5::Test Qt5::Widgets Qt5::X11Extras XCB::ICCCM XCB::KEYSYMS)
+      set(libs KF5::WindowSystem Qt5::Test Qt5::X11Extras XCB::ICCCM XCB::KEYSYMS)
       if(X11_FOUND)
          list(APPEND libs ${XCB_XCB_LIBRARY})
       endif()
+      if (NOT KWINDOWSYSTEM_NO_WIDGETS)
+         list(APPEND libs Qt5::Widgets)
+      endif()
       ecm_add_test(${_testname}.cpp LINK_LIBRARIES ${libs} NAME_PREFIX "kwindowsystem-" GUI)
    endforeach(_testname)
 endmacro(KWINDOWSYSTEM_UNIT_TESTS)
@@ -37,22 +40,25 @@ if(X11_FOUND)
     include_directories(${CMAKE_SOURCE_DIR}/src/platforms/xcb)
     kwindowsystem_unit_tests(
         kmanagerselectiontest
-        kstartupinfo_unittest
-        kxmessages_unittest
         kkeyserver_x11_unittest
     )
 
     kwindowsystem_unit_tests(
-        kwindoweffectstest
-        kwindowinfox11test
-        kwindowsystemx11test
-        kwindowsystem_threadtest
         netrootinfotestwm
         netwininfotestclient
         netwininfotestwm
         compositingenabled_test
     )
-    
+    if (NOT KWINDOWSYSTEM_NO_WIDGETS)
+        kwindowsystem_unit_tests(
+            kstartupinfo_unittest
+            kxmessages_unittest
+            kwindowinfox11test
+            kwindoweffectstest
+            kwindowsystemx11test
+            kwindowsystem_threadtest
+        )
+    endif()
     kwindowsystem_executable_tests(
         fixx11h_test
         fixx11h_test2
-- 
2.28.0

