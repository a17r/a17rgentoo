From e9676f39e4ab68cae91a7ed72279770126c49e2a Mon Sep 17 00:00:00 2001
From: Luke Dashjr <luke-jr+git@utopios.org>
Date: Sun, 27 Aug 2017 03:57:20 +0000
Subject: [PATCH 2/4] CMakeLists: KDEPIM_NO_AKONADI option to build without
 Akonadi

---
 CMakeLists.txt                  | 14 +++++++++++++-
 KdepimLibsConfig.cmake.in       |  2 +-
 includes/tests/CMakeLists.txt   |  7 +++++++
 kalarmcal/CMakeLists.txt        |  2 +-
 kmime/tests/auto/CMakeLists.txt |  4 +++-
 5 files changed, 25 insertions(+), 4 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 74bc0c281..df60911d0 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -41,6 +41,7 @@ endif()
 
 ############### Build Options ###############
 
+option(KDEPIM_NO_AKONADI "Build without Akonadi" FALSE)
 option(KDEPIM_ONLY_KLEO "Only build the libraries needed by Kleopatra." FALSE)
 cmake_dependent_option(KDEPIM_NO_KCAL "Build without legacy KCal" TRUE "KDE_PLATFORM_FEATURE_DISABLE_DEPRECATED" FALSE)
 cmake_dependent_option(KDEPIM_NO_KRESOURCES "Build without legacy KResource support." TRUE "KDE_PLATFORM_FEATURE_DISABLE_DEPRECATED" FALSE)
@@ -79,10 +80,12 @@ if (GPGME_FOUND)
 endif()
 
 if (NOT KDEPIM_ONLY_KLEO)
+  if (NOT KDEPIM_NO_AKONADI)
   #FindAkonadi.cmake is only there for compatibility reasons, but we don't want to use that.
   set(Akonadi_MIN_VERSION "1.12.90")
   find_package(Akonadi ${Akonadi_MIN_VERSION} QUIET NO_MODULE)
   set_package_properties(Akonadi PROPERTIES DESCRIPTION "Akonadi server libraries" URL "http://pim.kde.org/akonadi" TYPE REQUIRED PURPOSE "Access to PIM storage and services")
+  endif()
 
   find_package(Sasl2)
   set_package_properties(Sasl2 PROPERTIES DESCRIPTION "cyrus-sasl" URL "http://asg.web.cmu.edu/sasl/sasl-library.html" TYPE REQUIRED PURPOSE "Login authentication for IMAP and Sieve")
@@ -100,7 +103,7 @@ if (NOT KDEPIM_ONLY_KLEO)
   find_package(QJSON)
   set_package_properties(QJSON PROPERTIES DESCRIPTION "QJSON" URL "http://qjson.sourceforge.net/" TYPE REQUIRED PURPOSE "Qt library for handling JSON data")
 
-  if (KDE4_BUILD_TESTS)
+  if (KDE4_BUILD_TESTS AND NOT KDEPIM_NO_AKONADI)
     find_package(Xsltproc)
     set_package_properties(Xsltproc PROPERTIES DESCRIPTION "XSLT processor from libxslt" TYPE REQUIRED PURPOSE "Required to generate D-Bus interfaces for all Akonadi resources.")
 
@@ -121,6 +124,9 @@ endif()
 
 include_directories (${CMAKE_SOURCE_DIR} ${CMAKE_BINARY_DIR} ${KDE4_INCLUDES} ${Boost_INCLUDE_DIR})
 
+if (KDEPIM_NO_AKONADI)
+  add_definitions(-DKDEPIM_NO_AKONADI)
+endif()
 if (KDEPIM_NO_KRESOURCES)
   add_definitions(-DKDEPIM_NO_KRESOURCES)
 endif()
@@ -145,14 +151,18 @@ add_subdirectory(kde4_qgpgme)
 
 if (NOT KDEPIM_ONLY_KLEO)
   add_subdirectory(kabc)
+  if ((NOT KDEPIM_NO_AKONADI) OR (NOT KDEPIM_NO_KRESOURCES))
   add_subdirectory(kalarmcal)
+  endif()
   if (NOT KDEPIM_NO_KCAL)
     add_subdirectory(kblog)
     add_subdirectory(kcal)
   endif()
   add_subdirectory(kcalcore)
   add_subdirectory(kcalutils)
+  if (NOT KDEPIM_NO_AKONADI)
   add_subdirectory(akonadi) # depends on kabc is build
+  endif()
   add_subdirectory(kholidays)
   add_subdirectory(kimap)
   add_subdirectory(kioslave)
@@ -169,7 +179,9 @@ if (NOT KDEPIM_ONLY_KLEO)
   endif()
   add_subdirectory(ktnef)
   add_subdirectory(kxmlrpcclient)
+  if (NOT KDEPIM_NO_AKONADI)
   add_subdirectory(mailtransport)
+  endif()
   add_subdirectory(microblog)
   add_subdirectory(syndication)
   add_subdirectory(kontactinterface)
diff --git a/KdepimLibsConfig.cmake.in b/KdepimLibsConfig.cmake.in
index 4bb4d8b17..3e97cadfc 100644
--- a/KdepimLibsConfig.cmake.in
+++ b/KdepimLibsConfig.cmake.in
@@ -47,9 +47,9 @@ set(CMAKE_MODULE_PATH "${KDEPIMLIBS_DATA_DIR}/cmake/modules" "${CMAKE_MODULE_PAT
 # the exports file exports
 set(KDEPIMLIBS_TARGET_PREFIX @KDEPIMLIBS_TARGET_PREFIX@)
 
+set(KDEPIMLIBS_NO_AKONADI @KDEPIM_NO_AKONADI@)
 set(KDEPIMLIBS_NO_KRESOURCES @KDEPIM_NO_KRESOURCES@)
 set(KDEPIMLIBS_NO_KCAL @KDEPIM_NO_KCAL@)
-set(KALARM_USE_KRESOURCES @KALARM_USE_KRESOURCES@)
 
 # Make sure to load the exported targets only once
 # For the rest of this script it doesn't matter that much
diff --git a/includes/tests/CMakeLists.txt b/includes/tests/CMakeLists.txt
index f314c6160..313333e41 100644
--- a/includes/tests/CMakeLists.txt
+++ b/includes/tests/CMakeLists.txt
@@ -29,6 +29,7 @@ macro(add_includes _dir)
 endmacro()
 
 include_directories(
+  if (NOT KDEPIM_NO_AKONADI)
   # HACK: akonadi/calendar has a generated header. We need to go up 3 directories level
   ${CMAKE_BINARY_DIR}/akonadi/calendar/tests
   ${CMAKE_BINARY_DIR}/akonadi
@@ -39,6 +40,7 @@ include_directories(
   ${CMAKE_BINARY_DIR}/akonadi/kmime
   ${CMAKE_BINARY_DIR}/akonadi/notes
   ${CMAKE_BINARY_DIR}/akonadi/socialutils
+  endif()
   ${CMAKE_BINARY_DIR}/kabc
   ${CMAKE_BINARY_DIR}/kalarmcal
   ${CMAKE_BINARY_DIR}/kcal
@@ -61,7 +63,9 @@ include_directories(
   ${Boost_INCLUDE_DIR}
 )
 
+if (NOT KDEPIM_NO_AKONADI)
 add_includes( Akonadi )
+endif()
 add_includes( KABC )
 add_includes( KAlarmCal )
 add_includes( KCalCore )
@@ -86,12 +90,15 @@ add_includes( Mailtransport )
 add_includes( Syndication )
 
 add_definitions( -DQT_NO_CAST_FROM_ASCII -DQT_NO_CAST_TO_ASCII -DQT_NO_KEYWORDS -DQT_NO_CAST_FROM_BYTEARRAY -DQT_STRICT_ITERATORS )
+
+if (NOT KDEPIM_NO_AKONADI)
 kde4_add_executable( headercompiletest header_compile.cpp )
 target_link_libraries( headercompiletest ${QT_QTCORE_LIBRARY} )
 add_dependencies( headercompiletest akonadi-calendar ) # ensure calendarsettings.h is generated in parallel builds
 add_dependencies( headercompiletest kabc ) # ensure addressee.h is generated in parallel builds
 add_dependencies( headercompiletest kcal )
 add_dependencies( headercompiletest mailtransport ) # ensure transportbase.h is generated in parallel builds
+endif()
 
 endif()
 
diff --git a/kalarmcal/CMakeLists.txt b/kalarmcal/CMakeLists.txt
index 5f0b33f8c..5b15136ef 100644
--- a/kalarmcal/CMakeLists.txt
+++ b/kalarmcal/CMakeLists.txt
@@ -16,7 +16,7 @@ add_definitions( -DQT_NO_CAST_TO_ASCII )
 option(KALARM_USE_KRESOURCES "Build to use KResources" OFF)
 
 set(USE_KRESOURCES false)
-if(KALARM_USE_KRESOURCES AND NOT KDEPIM_NO_KRESOURCES)
+if((KALARM_USE_KRESOURCES AND NOT KDEPIM_NO_KRESOURCES) OR KDEPIM_NO_AKONADI)
     set(USE_KRESOURCES true)
     add_definitions(
       -DKRESOURCES_DEPRECATED=
diff --git a/kmime/tests/auto/CMakeLists.txt b/kmime/tests/auto/CMakeLists.txt
index 6419f4592..642692562 100644
--- a/kmime/tests/auto/CMakeLists.txt
+++ b/kmime/tests/auto/CMakeLists.txt
@@ -17,7 +17,6 @@ add_kmime_test(contentindextest.cpp)
 add_kmime_test(charfreqtest.cpp)
 add_kmime_test(headertest.cpp)
 add_kmime_test(contenttest.cpp)
-add_kmime_test(messagetest.cpp)
 add_kmime_test(codectest.cpp)
 #add_kmime_test(headerfactorytest.cpp)
 add_kmime_test(rfc2231test.cpp)
@@ -25,4 +24,7 @@ add_kmime_test(base64benchmark.cpp)
 add_kmime_test(sizetest.cpp)
 add_kmime_test(parsedatetimetest.cpp)
 
+if (NOT KDEPIM_NO_AKONADI)
+add_kmime_test(messagetest.cpp)
 target_link_libraries(messagetest akonadi-kde akonadi-kmime)
+endif()
-- 
2.14.1

