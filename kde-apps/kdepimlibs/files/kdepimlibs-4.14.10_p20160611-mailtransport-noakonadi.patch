From eb97e2b7cbae538eca5d518f2910b886b13ffc85 Mon Sep 17 00:00:00 2001
From: Luke Dashjr <luke-jr+git@utopios.org>
Date: Sun, 27 Aug 2017 06:03:28 +0000
Subject: [PATCH 3/4] mailtransport: Support building without Akonadi

---
 CMakeLists.txt                       |  2 --
 mailtransport/CMakeLists.txt         | 49 +++++++++++++++++++++++++++---------
 mailtransport/addtransportdialog.cpp |  4 +++
 mailtransport/tests/CMakeLists.txt   |  4 +++
 mailtransport/transport.cpp          |  6 +++++
 mailtransport/transportmanager.cpp   | 18 +++++++++++++
 mailtransport/transportmanager.h     |  4 +++
 mailtransport/transporttype.cpp      | 12 +++++++++
 mailtransport/transporttype.h        |  4 +++
 mailtransport/transporttype_p.h      |  6 +++++
 10 files changed, 95 insertions(+), 14 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index df60911d0..f388796c5 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -179,9 +179,7 @@ if (NOT KDEPIM_ONLY_KLEO)
   endif()
   add_subdirectory(ktnef)
   add_subdirectory(kxmlrpcclient)
-  if (NOT KDEPIM_NO_AKONADI)
   add_subdirectory(mailtransport)
-  endif()
   add_subdirectory(microblog)
   add_subdirectory(syndication)
   add_subdirectory(kontactinterface)
diff --git a/mailtransport/CMakeLists.txt b/mailtransport/CMakeLists.txt
index c86514d63..698216f1a 100644
--- a/mailtransport/CMakeLists.txt
+++ b/mailtransport/CMakeLists.txt
@@ -2,10 +2,15 @@ set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${KDE4_ENABLE_EXCEPTIONS}")
 
 include_directories(
   ${Boost_INCLUDE_DIR}
+  ${CMAKE_BINARY_DIR}/kmime
+)
+
+if (NOT KDEPIM_NO_AKONADI)
+include_directories(
   ${CMAKE_BINARY_DIR}/akonadi
   ${CMAKE_BINARY_DIR}/akonadi/kmime
-  ${CMAKE_BINARY_DIR}/kmime
 )
+endif()
 
 option(MAILTRANSPORT_INPROCESS_SMTP "false" "Use in-process SMTP instead of KIO slaves (note that this changes the mailtransport license from LGPL to GPL!)")
 
@@ -23,6 +28,10 @@ add_definitions(
   -DMAILTRANSPORT_DEPRECATED_EXPORT=MAILTRANSPORT_EXPORT
 )
 
+if (NOT KDEPIM_NO_AKONADI)
+  add_definitions("-DMAILTRANSPORT_AKONADI_SUPPORT")
+endif()
+
 if(MAILTRANSPORT_INPROCESS_SMTP)
   add_definitions("-DMAILTRANSPORT_INPROCESS_SMTP")
   include_directories(${SASL2_INCLUDE_DIR} ${CMAKE_SOURCE_DIR}/kioslave)
@@ -46,9 +55,7 @@ set(mailtransport_lib_srcs
   transportcombobox.cpp
   transportconfigwidget.cpp
 
-  filteractionjob.cpp
   transportjob.cpp
-  resourcesendjob.cpp
   sendmailjob.cpp
   smtpjob.cpp
   precommandjob.cpp
@@ -57,6 +64,22 @@ set(mailtransport_lib_srcs
   socket.cpp
   servertest.cpp
 
+  transportconfigdialog.cpp
+  sendmailconfigwidget.cpp
+  smtpconfigwidget.cpp
+
+  transportlistview.cpp
+  transportmanagementwidget.cpp
+  addtransportdialog.cpp
+)
+
+if (NOT KDEPIM_NO_AKONADI)
+set(mailtransport_lib_srcs
+  ${mailtransport_lib_srcs}
+
+  filteractionjob.cpp
+  resourcesendjob.cpp
+
   dispatcherinterface.cpp
   messagequeuejob.cpp
   outboxactions.cpp
@@ -67,14 +90,8 @@ set(mailtransport_lib_srcs
   sentactionattribute.cpp
   sentbehaviourattribute.cpp
   transportattribute.cpp
-  transportconfigdialog.cpp
-  sendmailconfigwidget.cpp
-  smtpconfigwidget.cpp
-
-  transportlistview.cpp
-  transportmanagementwidget.cpp
-  addtransportdialog.cpp
 )
+endif()
 
 kde4_add_ui_files(mailtransport_lib_srcs
   sendmailsettings.ui
@@ -91,7 +108,10 @@ kde4_add_kcfg_files(mailtransport_lib_srcs transportbase.kcfgc)
 
 add_library(mailtransport ${LIBRARY_TYPE} ${mailtransport_lib_srcs})
 generate_export_header(mailtransport)
-target_link_libraries(mailtransport LINK_PRIVATE ${KDE4_KIO_LIBS} akonadi-kde akonadi-kmime kmime)
+target_link_libraries(mailtransport LINK_PRIVATE ${KDE4_KIO_LIBS})
+if (NOT KDEPIM_NO_AKONADI)
+target_link_libraries(mailtransport LINK_PRIVATE akonadi-kde akonadi-kmime kmime)
+endif()
 if(MAILTRANSPORT_INPROCESS_SMTP)
   target_link_libraries(mailtransport LINK_PRIVATE ${SASL2_LIBRARIES} kpimutils)
 endif()
@@ -130,6 +150,11 @@ install(FILES
   transportconfigdialog.h
   transportmanagementwidget.h
 
+  DESTINATION ${INCLUDE_INSTALL_DIR}/mailtransport COMPONENT Devel
+)
+
+if (NOT KDEPIM_NO_AKONADI)
+install(FILES
   dispatcherinterface.h
   messagequeuejob.h
 
@@ -141,4 +166,4 @@ install(FILES
 
   DESTINATION ${INCLUDE_INSTALL_DIR}/mailtransport COMPONENT Devel
 )
-
+endif()
diff --git a/mailtransport/addtransportdialog.cpp b/mailtransport/addtransportdialog.cpp
index 732a34c5a..92f4defb6 100644
--- a/mailtransport/addtransportdialog.cpp
+++ b/mailtransport/addtransportdialog.cpp
@@ -27,8 +27,10 @@
 #include <KDebug>
 #include <KGlobal>
 
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
 #include <akonadi/agentinstance.h>
 #include <akonadi/agentinstancecreatejob.h>
+#endif
 
 using namespace MailTransport;
 
@@ -156,6 +158,7 @@ void AddTransportDialog::accept()
   // Create a new transport and configure it.
   Transport *transport = TransportManager::self()->createTransport();
   transport->setTransportType( d->selectedType() );
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
   if ( d->selectedType().type() == Transport::EnumType::Akonadi ) {
     // Create a resource instance if Akonadi-type transport.
     using namespace Akonadi;
@@ -167,6 +170,7 @@ void AddTransportDialog::accept()
     }
     transport->setHost( cjob->instance().identifier() );
   }
+#endif
   transport->setName( d->ui.name->text().trimmed() );
   transport->forceUniqueName();
   if ( TransportManager::self()->configureTransport( transport, this ) ) {
diff --git a/mailtransport/tests/CMakeLists.txt b/mailtransport/tests/CMakeLists.txt
index f83acc72c..6300c1509 100644
--- a/mailtransport/tests/CMakeLists.txt
+++ b/mailtransport/tests/CMakeLists.txt
@@ -47,6 +47,8 @@ set(tm_srcs transportmgr.cpp)
 kde4_add_executable(transportmgr TEST ${tm_srcs})
 target_link_libraries(transportmgr ${KDE4_KDEUI_LIBS} mailtransport)
 
+if (NOT KDEPIM_NO_AKONADI)
+
 set(queuer_srcs queuer.cpp)
 kde4_add_executable(queuer TEST ${queuer_srcs})
 target_link_libraries(queuer ${KDE4_KDEUI_LIBS} mailtransport kmime akonadi-kde akonadi-kmime)
@@ -71,3 +73,5 @@ add_akonadi_isolated_test( filteractiontest.cpp unittestenv_akonadi )
 if (KDEPIMLIBS_RUN_KDEPIMRUNTIME_ISOLATED_TESTS)
     add_akonadi_isolated_test( messagequeuejobtest.cpp unittestenv )
 endif ()
+
+endif()
diff --git a/mailtransport/transport.cpp b/mailtransport/transport.cpp
index 8f3c2db15..e333ad0b3 100644
--- a/mailtransport/transport.cpp
+++ b/mailtransport/transport.cpp
@@ -33,8 +33,10 @@
 #include <KStringHandler>
 #include <KWallet/Wallet>
 
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
 #include <akonadi/agentinstance.h>
 #include <akonadi/agentmanager.h>
+#endif
 
 using namespace MailTransport;
 using namespace KWallet;
@@ -162,10 +164,13 @@ void Transport::usrReadConfig()
 
   // Set TransportType.
   {
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
     using namespace Akonadi;
+#endif
     d->transportType = TransportType();
     d->transportType.d->mType = type();
     kDebug() << "type" << type();
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
     if ( type() == EnumType::Akonadi ) {
       const AgentInstance instance = AgentManager::self()->instance( host() );
       if ( !instance.isValid() ) {
@@ -174,6 +179,7 @@ void Transport::usrReadConfig()
       d->transportType.d->mAgentType = instance.type();
       kDebug() << "agent type" << instance.type().name() << "id" << instance.type().identifier();
     }
+#endif
     // Now we have the type and possibly agentType.  Get the name, description
     // etc. from TransportManager.
     const TransportType::List &types = TransportManager::self()->types();
diff --git a/mailtransport/transportmanager.cpp b/mailtransport/transportmanager.cpp
index d13f87957..a4f382191 100644
--- a/mailtransport/transportmanager.cpp
+++ b/mailtransport/transportmanager.cpp
@@ -18,7 +18,9 @@
 */
 
 #include "transportmanager.h"
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
 #include "resourcesendjob_p.h"
+#endif
 #include "mailtransport_defs.h"
 #include "sendmailjob.h"
 #include "smtpjob.h"
@@ -52,8 +54,10 @@
 #include <KGlobal>
 #include <KWallet/Wallet>
 
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
 #include <akonadi/agentinstance.h>
 #include <akonadi/agentmanager.h>
+#endif
 
 using namespace MailTransport;
 using namespace KWallet;
@@ -101,8 +105,10 @@ class TransportManagerPrivate
     void slotTransportsChanged();
     void slotWalletOpened( bool success );
     void dbusServiceUnregistered();
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
     void agentTypeAdded( const Akonadi::AgentType &atype );
     void agentTypeRemoved( const Akonadi::AgentType &atype );
+#endif
     void jobResult( KJob *job );
 };
 
@@ -124,7 +130,9 @@ TransportManager::TransportManager()
   : QObject(), d( new TransportManagerPrivate( this ) )
 {
   KGlobal::locale()->insertCatalog( QLatin1String( "libmailtransport" ) );
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
   KGlobal::locale()->insertCatalog( QLatin1String( "libakonadi-kmime" ) );
+#endif
   qAddPostRoutine( destroyStaticTransportManager );
   d->myOwnChange = false;
   d->appliedChange = false;
@@ -281,6 +289,7 @@ bool TransportManager::showTransportCreationDialog( QWidget *parent,
 
 bool TransportManager::configureTransport( Transport *transport, QWidget *parent )
 {
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
   if ( transport->type() == Transport::EnumType::Akonadi ) {
     using namespace Akonadi;
     AgentInstance instance = AgentManager::self()->instance( transport->host() );
@@ -291,6 +300,7 @@ bool TransportManager::configureTransport( Transport *transport, QWidget *parent
     transport->writeConfig();
     return true; // No way to know here if the user cancelled or not.
   }
+#endif
 
   QPointer<TransportConfigDialog> transportConfigDialog =
     new TransportConfigDialog( transport, parent );
@@ -313,8 +323,10 @@ TransportJob *TransportManager::createTransportJob( int transportId )
     return new SmtpJob( t, this );
   case Transport::EnumType::Sendmail:
     return new SendmailJob( t, this );
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
   case Transport::EnumType::Akonadi:
     return new ResourceSendJob( t, this );
+#endif
   }
   Q_ASSERT( false );
   return 0;
@@ -395,6 +407,7 @@ void TransportManager::removeTransport( int id )
   }
   emit transportRemoved( t->id(), t->name() );
 
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
   // Kill the resource, if Akonadi-type transport.
   if ( t->type() == Transport::EnumType::Akonadi ) {
     using namespace Akonadi;
@@ -404,6 +417,7 @@ void TransportManager::removeTransport( int id )
     }
     AgentManager::self()->removeInstance( instance );
   }
+#endif
 
   d->transports.removeAll( t );
   d->validateDefault();
@@ -506,6 +520,7 @@ void TransportManagerPrivate::fillTypes()
     types << type;
   }
 
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
   // All Akonadi resources with MailTransport capability.
   {
     using namespace Akonadi;
@@ -529,6 +544,7 @@ void TransportManagerPrivate::fillTypes()
     QObject::connect( AgentManager::self(), SIGNAL(typeRemoved(Akonadi::AgentType)),
         q, SLOT(agentTypeRemoved(Akonadi::AgentType)) );
   }
+#endif
 
   kDebug() << "Have SMTP, Sendmail, and" << types.count() - 2 << "Akonadi types.";
 }
@@ -748,6 +764,7 @@ void TransportManagerPrivate::dbusServiceUnregistered()
   QDBusConnection::sessionBus().registerService( DBUS_SERVICE_NAME );
 }
 
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
 void TransportManagerPrivate::agentTypeAdded( const Akonadi::AgentType &atype )
 {
   using namespace Akonadi;
@@ -773,6 +790,7 @@ void TransportManagerPrivate::agentTypeRemoved( const Akonadi::AgentType &atype
     }
   }
 }
+#endif
 
 void TransportManagerPrivate::jobResult( KJob *job )
 {
diff --git a/mailtransport/transportmanager.h b/mailtransport/transportmanager.h
index a5a8d95c6..0ff7c2eab 100644
--- a/mailtransport/transportmanager.h
+++ b/mailtransport/transportmanager.h
@@ -26,7 +26,9 @@
 #include <QtCore/QList>
 #include <QtCore/QObject>
 
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
 #include <akonadi/agenttype.h>
+#endif
 
 class KJob;
 
@@ -293,8 +295,10 @@ class MAILTRANSPORT_EXPORT TransportManager : public QObject
     Q_PRIVATE_SLOT( d, void slotTransportsChanged() )
     Q_PRIVATE_SLOT( d, void slotWalletOpened( bool success ) )
     Q_PRIVATE_SLOT( d, void dbusServiceUnregistered() )
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
     Q_PRIVATE_SLOT( d, void agentTypeAdded( const Akonadi::AgentType &atype ) )
     Q_PRIVATE_SLOT( d, void agentTypeRemoved( const Akonadi::AgentType &atype ) )
+#endif
     Q_PRIVATE_SLOT( d, void jobResult( KJob *job ) )
 };
 
diff --git a/mailtransport/transporttype.cpp b/mailtransport/transporttype.cpp
index f6719bd95..d6e1e5677 100644
--- a/mailtransport/transporttype.cpp
+++ b/mailtransport/transporttype.cpp
@@ -21,7 +21,9 @@
 #include "transporttype_p.h"
 #include "transport.h"
 
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
 #include <akonadi/agentmanager.h>
+#endif
 
 using namespace MailTransport;
 
@@ -49,20 +51,28 @@ TransportType &TransportType::operator=( const TransportType &other )
 
 bool TransportType::operator==( const TransportType &other ) const
 {
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
   if ( d->mType == Transport::EnumType::Akonadi &&
        other.d->mType == Transport::EnumType::Akonadi ) {
     return ( d->mAgentType == other.d->mAgentType );
   }
+#endif
   return ( d->mType == other.d->mType );
 }
 
 bool TransportType::isValid() const
 {
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
   using namespace Akonadi;
+#endif
 
   if ( d->mType == Transport::EnumType::Akonadi ) {
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
     return d->mAgentType.isValid() &&
       AgentManager::self()->types().contains( d->mAgentType );
+#else
+    return false;
+#endif
   } else {
     return d->mType >= 0;
   }
@@ -83,8 +93,10 @@ QString TransportType::description() const
   return d->mDescription;
 }
 
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
 Akonadi::AgentType TransportType::agentType() const
 {
   Q_ASSERT( d->mType == Transport::EnumType::Akonadi );
   return d->mAgentType;
 }
+#endif
diff --git a/mailtransport/transporttype.h b/mailtransport/transporttype.h
index f8e64e74e..7f84f3253 100644
--- a/mailtransport/transporttype.h
+++ b/mailtransport/transporttype.h
@@ -25,7 +25,9 @@
 
 #include <QtCore/QString>
 
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
 #include <akonadi/agenttype.h>
+#endif
 
 namespace MailTransport {
 
@@ -107,11 +109,13 @@ class MAILTRANSPORT_EXPORT TransportType
     */
     QString description() const;
 
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
     /**
       Returns the corresponding Akonadi::AgentType that this transport type
       represents.  Only valid if type() is Transport::EnumType::Akonadi.
     */
     Akonadi::AgentType agentType() const;
+#endif
 
   private:
     //@cond PRIVATE
diff --git a/mailtransport/transporttype_p.h b/mailtransport/transporttype_p.h
index 407d191ca..caa617eed 100644
--- a/mailtransport/transporttype_p.h
+++ b/mailtransport/transporttype_p.h
@@ -23,7 +23,9 @@
 #include <QtCore/QSharedData>
 #include <QtCore/QString>
 
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
 #include <akonadi/agenttype.h>
+#endif
 
 namespace MailTransport {
 
@@ -44,13 +46,17 @@ class TransportType::Private : public QSharedData
       mType = other.mType;
       mName = other.mName;
       mDescription = other.mDescription;
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
       mAgentType = other.mAgentType;
+#endif
     }
 
     int mType;
     QString mName;
     QString mDescription;
+#ifdef MAILTRANSPORT_AKONADI_SUPPORT
     Akonadi::AgentType mAgentType;
+#endif
 };
 
 } // namespace MailTransport
-- 
2.14.1

