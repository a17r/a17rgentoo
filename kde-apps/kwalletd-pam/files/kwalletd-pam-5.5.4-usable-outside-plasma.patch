commit c974341fe3502c46d275ff56ae36477ed7cc573d
Author: Armin K <krejzi@email.com>
Date:   Tue Jan 26 12:16:43 2016 +0100

    Make kwallet-pam usable outside of Plasma
    
    REVIEW: 126843

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 8bd526e..b8f9a2b 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -1,14 +1,24 @@
 project(pam_kwallet)
-cmake_minimum_required(VERSION 2.8.8)
+cmake_minimum_required(VERSION 2.8.12)
 
 set(PROJECT_VERSION "5.5.4")
 set(PROJECT_VERSION_MAJOR 5)
 
-set(CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/cmake/modules" )
+find_package (ECM 1.2.0 REQUIRED NO_MODULE)
+set (CMAKE_MODULE_PATH ${ECM_MODULE_PATH} "${CMAKE_CURRENT_SOURCE_DIR}/cmake/modules" )
+
+include(KDEInstallDirs)
 
 find_package(PAM REQUIRED)
 find_package(LibGcrypt 1.5.0 REQUIRED)
-include(GNUInstallDirs)
+
+find_program(SOCAT_EXECUTABLE socat)
+
+if (SOCAT_EXECUTABLE)
+  message (STATUS "Found socat executable: ${SOCAT_EXECUTABLE}")
+else ()
+  message (FATAL_ERROR "socat is required for pam_kwallet to work")
+endif ()
 
 include_directories (
    ${PAM_INCLUDE_DIR}
@@ -43,3 +53,9 @@ target_link_libraries (${library_name}
 )
 
 install(TARGETS ${library_name} DESTINATION ${CMAKE_INSTALL_LIBDIR}/security)
+
+configure_file(pam_kwallet_init.desktop.cmake ${CMAKE_BINARY_DIR}/pam_kwallet_init.desktop)
+
+install(PROGRAMS pam_kwallet_init DESTINATION ${LIBEXEC_INSTALL_DIR})
+
+install(FILES ${CMAKE_BINARY_DIR}/pam_kwallet_init.desktop DESTINATION ${AUTOSTART_INSTALL_DIR})
diff --git a/pam_kwallet_init b/pam_kwallet_init
new file mode 100644
index 0000000..e1d7f1a
--- /dev/null
+++ b/pam_kwallet_init
@@ -0,0 +1,10 @@
+#!/bin/sh
+
+if test -n "$PAM_KWALLET_LOGIN" ; then
+    env | socat STDIN UNIX-CONNECT:$PAM_KWALLET_LOGIN
+fi
+
+if test -n "$PAM_KWALLET5_LOGIN" ; then
+    env | socat STDIN UNIX-CONNECT:$PAM_KWALLET5_LOGIN
+fi
+
diff --git a/pam_kwallet_init.desktop.cmake b/pam_kwallet_init.desktop.cmake
new file mode 100644
index 0000000..793d72f
--- /dev/null
+++ b/pam_kwallet_init.desktop.cmake
@@ -0,0 +1,8 @@
+[Desktop Entry]
+Name=KWallet PAM Socket Connection
+Comment=Connect to KWallet PAM socket
+Exec=${CMAKE_INSTALL_FULL_LIBEXECDIR}/pam_kwallet_init
+Type=Application
+NoDisplay=true
+X-KDE-StartupNotify=false
+X-KDE-autostart-phase=0
