--- /usr/portage/sys-apps/dbus/dbus-1.6.16.ebuild	2013-10-08 19:50:16.000000000 +0300
+++ /usr/local/portage/sys-apps/dbus/dbus-1.6.16-r1.ebuild	2013-10-17 17:06:53.508062261 +0300
@@ -1,10 +1,10 @@
 # Copyright 1999-2013 Gentoo Foundation
 # Distributed under the terms of the GNU General Public License v2
-# $Header: /var/cvsroot/gentoo-x86/sys-apps/dbus/dbus-1.6.16.ebuild,v 1.1 2013/10/08 16:50:16 ssuominen Exp $
+# $Header: $
 
 EAPI=5
 PYTHON_COMPAT=( python2_7 )
-inherit autotools eutils linux-info flag-o-matic python-any-r1 systemd virtualx user
+inherit autotools eutils linux-info flag-o-matic multilib multilib-minimal python-any-r1 systemd virtualx user
 
 DESCRIPTION="A message bus system, a simple way for applications to talk to each other"
 HOMEPAGE="http://dbus.freedesktop.org/"
@@ -15,15 +15,19 @@
 KEYWORDS="~alpha ~amd64 ~arm ~hppa ~ia64 ~mips ~ppc ~ppc64 ~s390 ~sh ~sparc ~x86 ~amd64-fbsd ~x86-fbsd ~arm-linux ~x86-linux"
 IUSE="debug doc selinux static-libs systemd test X"
 
-RDEPEND=">=dev-libs/expat-2
+RDEPEND=">=dev-libs/expat-2[${MULTILIB_USEDEP}]
+	abi_x86_32? (
+		!<=app-emulation/emul-linux-x86-baselibs-20131008-r2
+		!app-emulation/emul-linux-x86-baselibs[-abi_x86_32(-)]
+	)
 	selinux? (
 		sec-policy/selinux-dbus
 		sys-libs/libselinux
 		)
-	systemd? ( sys-apps/systemd )
+	systemd? ( sys-apps/systemd[${MULTILIB_USEDEP}] )
 	X? (
-		x11-libs/libX11
-		x11-libs/libXt
+		x11-libs/libX11[${MULTILIB_USEDEP}]
+		x11-libs/libXt[${MULTILIB_USEDEP}]
 		)"
 DEPEND="${RDEPEND}
 	virtual/pkgconfig
@@ -33,15 +37,10 @@
 		app-text/xmlto
 		)
 	test? (
-		>=dev-libs/glib-2.24
+		>=dev-libs/glib-2.24[${MULTILIB_USEDEP}]
 		${PYTHON_DEPS}
 		)"
 
-# out of sources build directory
-BD=${WORKDIR}/${P}-build
-# out of sources build dir for make check
-TBD=${WORKDIR}/${P}-tests-build
-
 pkg_setup() {
 	enewgroup messagebus
 	enewuser messagebus -1 -1 -1 messagebus
@@ -68,7 +67,7 @@
 	eautoreconf
 }
 
-src_configure() {
+multilib_src_configure() {
 	local myconf
 
 	# so we can get backtraces from apps
@@ -102,17 +101,15 @@
 		"$(systemd_with_unitdir)"
 		)
 
-	mkdir "${BD}"
-	cd "${BD}"
-	einfo "Running configure in ${BD}"
+	einfo "Running configure in $(pwd)"
 	ECONF_SOURCE="${S}" econf "${myconf[@]}" \
 		$(use_enable doc xml-docs) \
 		$(use_enable doc doxygen-docs)
 
 	if use test; then
-		mkdir "${TBD}"
-		cd "${TBD}"
-		einfo "Running configure in ${TBD}"
+		mkdir "${BUILD_DIR}-tests"
+		cd "${BUILD_DIR}-tests"
+		einfo "Running configure in $(pwd)"
 		ECONF_SOURCE="${S}" econf "${myconf[@]}" \
 			$(use_enable test asserts) \
 			$(use_enable test checks) \
@@ -121,28 +118,32 @@
 	fi
 }
 
-src_compile() {
+multilib_src_compile() {
 	# after the compile, it uses a selinuxfs interface to
 	# check if the SELinux policy has the right support
 	use selinux && addwrite /selinux/access
 
-	cd "${BD}"
-	einfo "Running make in ${BD}"
+	einfo "Running make in $(pwd)"
 	emake
 
 	if use test; then
-		cd "${TBD}"
-		einfo "Running make in ${TBD}"
+		cd "${BUILD_DIR}-tests"
+		einfo "Running make in $(pwd)"
 		emake
 	fi
 }
 
-src_test() {
-	cd "${TBD}"
+multilib_src_test() {
+	cd "${BUILD_DIR}-tests"
 	DBUS_VERBOSE=1 Xemake -j1 check
 }
 
-src_install() {
+multilib_src_install() {
+	einfo "Running make install in $(pwd)"
+	emake DESTDIR="${D}" install
+}
+
+multilib_src_install_all() {
 	newinitd "${FILESDIR}"/dbus.initd dbus
 
 	if use X; then
@@ -161,9 +162,6 @@
 
 	dodoc AUTHORS ChangeLog HACKING NEWS README doc/TODO
 
-	cd "${BD}"
-	emake DESTDIR="${D}" install
-
 	prune_libtool_files --all
 }
 

